1、在文件 Common/function.php 中的T函数后面取消return语句行，并新增：

/**
 * [SWH|+] OpenCenter/ThinkOX 新增对common下的模板检测
 * 在上面的T函数最后调用：
 * return templateFileChecker($baseUrl,$file,$theme,$extend);
 */
function templateFileChecker($baseUrl, $file, $theme, $extend) {
	if ($extend == 'Addons') {
		if ($theme) {
			$result = $baseUrl . $theme . '/' . $file . C('TMPL_TEMPLATE_SUFFIX');
			if (file_exists($result)) {
				return $result;
			}
		}
		$result = $baseUrl . $file . C('TMPL_TEMPLATE_SUFFIX');
	} else {
		$result = $baseUrl . ($theme ? $theme . '/' : '') . $file . C('TMPL_TEMPLATE_SUFFIX');
	}
	//如果模版存在，则返回该模版
	if (file_exists($result)) {
		return $result;
	}
	//如果模版不存在，则返回公共目录下的模版
	$baseUrl = APP_PATH . 'Common/View/' . ($theme ? $theme . '/' : '');
	$result = $baseUrl . $file . C('TMPL_TEMPLATE_SUFFIX');
	return $result;
}

并照上面注释中所述修改T函数。

2、在文件 Library\Think\Dispatcher.class.php 中Dispatcher类中新增以下方法：

	/**
	 * 清理掉上面getSpace、getModule、getAction、getController方法结果中的非法字符。
	 * 在这三个函数的return部分用self::cleanNotWords(...)包裹即可。
	 * @param  string  $str 	字符串
	 * @param  boolean $allowSlash 	是否允许斜杠（用于getController方法）
	 * @return string
	 * @author swh <swh@admpub.com>
	 */
	static private function cleanNotWords($str, $allowSlash = false) {
		if ($allowSlash) {
			if (strpos($str, '/_')) {
				return '';
			}
			$str = preg_replace('|[^\\w/]+|', '', $str);
			return $str;
		}
		if ($str[0] == '_') {
			return '';
		}
		$str = preg_replace('/[^\\w]+/', '', $str);
		return $str;
	}

并照上面注释中所述修改getSpace、getModule、getAction、getController函数。
注意，在getController函数中调用cleanNotWords时，请把cleanNotWords的第二个参数设为true。

3、将 ThinkPHP.php 文件中的：
define('_PHP_FILE_',    rtrim(str_replace($_SERVER['HTTP_HOST'],'',$_temp[0].'.php'),'/'));
改为：
define('_PHP_FILE_',    $_temp[0].'.php');//[SWH|+]


4、文件 Library\Think\Page.class.php 有修改请不要直接覆盖，如果已经覆盖了，请使用 Library\Think\Page.modified-bak.class.php 文件还原。

-EOF-